<!DOCTYPE HTML>
<html>

<head>
    <title>百度地图</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
    body,
    html,
    #allmap {
        width: 100%;
        height: 100%;
        overflow: hidden;
        margin: 0;
        font-family: "微软雅黑";
    }
    </style>
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=7ZxBdiEy31AKf8KWRtzGNH9CptMmxkd7"></script>
    <script type='text/javascript'>
    function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showMap, handleError, {
                enableHighAccuracy: true,
                maximumAge: 1000
            });
        } else {
            alert('您的浏览器不支持使用HTML 5来获取地理位置服务');
        }
    }

    function showMap(value) {
        var x = value.coords.longitude; //原始坐标121.450997,31.234389
        var y = value.coords.latitude;
        var ggPoint = new BMap.Point(x, y);

        var map = new BMap.Map("allmap");
        map.centerAndZoom(ggPoint, 15);

        //坐标转换完之后的回调函数
        translateCallback = function(data) {
            if (data.status === 0) {
                //alert(JSON.stringify(data));
                var newX = data.points[0].lng;
                var newY = data.points[0].lat;

                alert(newX);//121.46201261741
                alert(newY);//31.238904663287
                //data.points[0].lng   data.points[0].lat
                var myP1 = new BMap.Point(newX, newY); //起点
                var myP2 = new BMap.Point(121.535155, 31.238999); //终点
                var myIcon = new BMap.Icon("http://developer.baidu.com/map/jsdemo/img/Mario.png", new BMap.Size(32, 70), { //小车图片
                    //offset: new BMap.Size(0, -5),    //相当于CSS精灵
                    imageOffset: new BMap.Size(0, 0) //图片的偏移量。为了是图片底部中心对准坐标点。
                });
                var driving2 = new BMap.DrivingRoute(map, {
                    renderOptions: {
                        map: map,
                        autoViewport: true
                    }
                }); //驾车实例
                driving2.search(myP1, myP2); //显示一条公交线路

                window.run = function() {
                    var driving = new BMap.DrivingRoute(map); //驾车实例
                    driving.search(myP1, myP2);
                    driving.setSearchCompleteCallback(function() {
                        var pts = driving.getResults().getPlan(0).getRoute(0).getPath(); //通过驾车实例，获得一系列点的数组
                        var paths = pts.length; //获得有几个点

                        var carMk = new BMap.Marker(pts[0], {
                            icon: myIcon
                        });
                        map.addOverlay(carMk);
                        i = 0;

                        function resetMkPoint(i) {
                            carMk.setPosition(pts[i]);
                            if (i < paths) {
                                setTimeout(function() {
                                    i++;
                                    resetMkPoint(i);
                                }, 100);
                            }
                        }
                        setTimeout(function() {
                            resetMkPoint(5);
                        }, 100)
                    });
                }

                setTimeout(function() {
                    run();
                }, 1500);
            }
        }

        //原始坐标转百度坐标
        var convertor = new BMap.Convertor();
        var pointArr = [];
        pointArr.push(ggPoint);
        convertor.translate(pointArr, 1, 5, translateCallback);
    }

    function handleError(value) {
        switch (value.code) {
            case 1:
                alert('位置服务被拒绝');
                break;
            case 2:
                alert('暂时获取不到位置信息');
                break;
            case 3:
                alert('获取信息超时');
                break;
            case 4:
                alert('未知错误');
                break;
        }
    }

    function init() {
        getLocation();
    }

    window.onload = init;
    </script>
</head>

<body>
    <div id='allmap'></div>
</body>

</html>
